<!DOCTYPE html>
<html>
<head>
  <title>RedbullStratos</title>
  <meta charset="utf-8" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      font-family: helvetica;
      font-size: 11px;
      position: relative;
    }

    html, body, #map {
      height: 100%;
      padding: 0;
      margin: 0;
    }

    #overlay {
      background: url('overlay_top.png');
      position: absolute;
      top: 0;
      left: 0;
      width: 600px;
      height: 600px;
      display:  none;
    /*  pointer-events: none;*/
    }

    #vel {
      position: absolute;
      top: 307px;
      left: 110px;
    }

    #alt{
      position: absolute;
      top: 281px;
      left: 358px;
    }

    #legend {
      position: absolute;
      top: 20px;
      left: 20px;
      font-weight: bold;
      color: white;
      font-size: 17px;
      background: rgba(0, 0, 0, 0.75);
      padding: 10px 20px;
    }

  </style>


  <link rel="stylesheet" href="./dist/leaflet.css" />
  <!--[if lte IE 8]><link rel="stylesheet" href="./dist/leaflet.ie.css" /><![endif]-->
</head>
<body>
  <div id="map" ></div>
  <div id="legend">
    Felix Baumgartnerâ€™s supersonic freefall
  </div>
  <div id="overlay">
    <div id="vel">VERTICAL SPEED: <span id="spd">0m/s</span></div>
    <div id="alt">ALTITUDE: <span id="a">0</span></div>
  </div>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
  <script src="./dist/leaflet.js"></script>
  <script>


    var icon = L.icon({
        iconUrl: 'perico.png',
        iconSize: [25, 25],
        iconAnchor: [12, 12]
    });

    
    var perico = null;

    var lastPos;
    var map;
    var fn = function() {
      $.getJSON('http://javi.cartodb.com/api/v2/sql?q=select * from stratos order by cartodb_id desc limit 1&format=geojson', function(data) {
        var lnglat = data.features[0].geometry.coordinates;
        var pos = new L.LatLng(lnglat[1], lnglat[0]);
        lastPos = pos;

        if(!perico) {

          map = L.map('map', {zoomControl: false, dragging: false}).setView(pos, 5);

          L.tileLayer('http://a.tiles.mapbox.com/v3/saleiva.map-3icvoove/{z}/{x}/{y}.png', {
            maxZoom: 18,
            attribution: "<a href='http://mapbox.com/about/maps' target='_blank'>Mapbox</a>",
          }).addTo(map);

          perico = new L.Marker(new L.LatLng(0, 0), {
            icon: icon
          }).addTo(map);

          $('#overlay').show();
          //map.setView(pos, 7);

          map.on('move', function() {
            var point = map.latLngToLayerPoint(lastPos);
            $('#overlay').css({
              top: point.y - 300,
              left: point.x - 300
            });
          });
        }
        perico.setLatLng(pos);
        //map.panTo(pos);
        var point = map.latLngToLayerPoint(pos);
        $('#overlay').css({
          top: point.y - 300,
          left: point.x - 300
        });
        var altitudemetric = data.features[0].properties.altitudemetric > 0? data.features[0].properties.altitudemetric : 0;
        $('#spd').html(data.features[0].properties.verticalspeedmetric + " m/s");
        $('#a').html(altitudemetric + " m");
      });
    }
    fn();
    setInterval(fn, 3000);


  </script>
  <a id="cartodb_logo" style="position:absolute; bottom:8px; left:8px; display:block; z-index:10000;" href="http://www.cartodb.com" target="_blank"><img src="http://cartodb.s3.amazonaws.com/static/new_logo.png" style="border:none; outline:none" alt="CartoDB" title="CartoDB">
  </a>
</body>
</html>
